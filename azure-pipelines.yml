pool:
  vmImage: 'vs2017-win2016'

steps:
- script: npm install
  workingDirectory: ./src/SlowSlothBudget.Web/ClientApp
  displayName: 'Restore npm packages'

- script: dotnet restore ./src/SlowSlothBudget.Web/SlowSlothBudget.Web.csproj
  displayName: 'Restore NuGet packages'

- script: dotnet build -c Release ./src/SlowSlothBudget.Web/SlowSlothBudget.Web.csproj
  displayName: 'Build the project'

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: '**/*Test/*.csproj'
    arguments: '--configuration Release'
  displayName: 'Run back-end unit tests'

- script: set CI=true && npm test
  workingDirectory: ./src/SlowSlothBudget.Web/ClientApp
  displayName: 'Run front-end unit tests'

- script: dotnet publish -c Release -o ./publish ./src/SlowSlothBudget.Web/SlowSlothBudget.Web.csproj
  displayName: 'Create project release files'

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: './src/SlowSlothBudget.Web/publish'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(System.ArtifactsDirectory)/slowslothbudget.zip'
    replaceExistingArchive: true
  displayName: 'Create release artifact'

- task: AzureAppServiceManage@0
  inputs:
    azureSubscription: 'slowslothbudget'
    action: 'stop Azure App Service'
    webAppName: 'slowslothbudget'
  displayName: 'Stop the application'

- task: AzureRmWebAppDeployment@3
  inputs:
    azureSubscription: 'slowslothbudget'
    WebAppName: 'slowslothbudget'
    Package: $(System.ArtifactsDirectory)/**/*.zip
  displayName: 'Deploy the application'

- task: AzureAppServiceManage@0
  inputs:
    azureSubscription: 'slowslothbudget'
    action: 'start Azure App Service'
    webAppName: 'slowslothbudget'
  displayName: 'Start the application'